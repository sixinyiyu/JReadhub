> 秒杀系统的架构设计

在电商平台经常会有抢购、秒杀等活动；一般此类活动主要有商品库存比较小、活动时间非常短、瞬时并发量非常高等特性。所以在架构设计的时候我们要多参考业务的特性来进行针对设计。

![具体业务流程](http://wx2.sinaimg.cn/large/9c349f47gy1fz1iaernxaj20kq0m1gme.jpg)

1. 秒杀活动开始前，用户肯定也是会很频繁的刷新页面看看活动信息(商品介绍、价格、库存)；这个时间段完全可以全部走缓存，在活动商品信息设置完成后，先可以将信息刷到缓存中去，这样一来用户访问就大概率是走缓存，用户体验会比较好，活动未开始时下单按钮不可点击，秒杀结束后按钮同样不可点击

2. 秒杀开始，这个阶段那个瞬时并发量非常巨大的，如果处理不好就会全部压到服务器甚至到了数据库，那就可能gg了；这里就需要活用削峰、异步了；
首先不能把所有请求直接都放过去，也不能采用串行执行(相应慢了用户会骂娘的)，更加要保证业务正确(不能超卖！！！绝对不能) 。 假设活动库存为10，下单请求有10w，那也没有用后面的9w多请求都是无效的，所以我们采用队列机制，最多放几十个请求进去，后面的请求直接返回已售完。
而处理这几十个请求也用异步来处理

3. 建议采用MQ来削峰，假设允许20个请求进入MQ，然后采用主动拉去MQ队列的消息进行处理，采取下单锁库存策略，库存锁定成功就表示用户抢购成功，只需要要付款即可了，锁库存也可以采用Redis原子操作(天然原子性避免超卖情况)或者采用乐观锁都可以的

4. 秒杀活动也是一种营销活动，最好不要跟其他活动耦合在营销系统中，秒杀系统要做成一个单独的服务，避免因为瞬时大流量对整个系统产生影响；此外还需要考虑有人直接请求URL的情况，频繁下单的情况都需要做限制

5. 秒杀的主要功能就是能给用户查询秒杀商品、下单、付款，一些非重要性的服务在特殊情况下可以走降级或者缓存(少量数据不实时可以接受)

一些优化点：


* 活动开始前，先将商品秒杀库存存到redis中，提交秒杀请求的时候先做一个前置验证，商品库存为0则秒杀结束直接返回，并且可以采用布隆过滤来避免用户频繁提交请求(前一个请求未处理完再次提交)来限制用户频繁提交请求。

* 在商品没有库存的时候可以将状态标志同步到内存中去，避免一些网络请求

* 前端的静态资源能放cdn的就放

* 后端秒杀url要做成动态的最好，避免有人直接搞到请求来秒杀